import tweepy
import time
import data_access as dal
import requests


def main():
    data = dal.getData()

    BOT_TOKEN = data['botToken']
    CHANNEL_ID = data['channelId']

    twitterApi = getTwitterAPI(data)
    lastId = data['lastId']
    tweets = []

    print('Begining the loop...' + '\n')

    while True:
        try:
            print('Checks for tweets...' + '\n')
            tweets = twitterApi.home_timeline(since_id=lastId)
            if tweets:
                print('Tweets found!' + '\n')
                for tweet in tweets:
                    message = getMessage(tweet)
                    send_message(message, BOT_TOKEN, CHANNEL_ID)
                    print('telegramed!\n')
                lastId = tweets[0].id
                data['lastId'] = lastId
                dal.setData(data)
            else:
                print('No new tweets!' + '\n')
        except tweepy.RateLimitError as e:
            lastId = tweets[0].id
            data['lastId'] = lastId
            dal.setData(data)
            print('We hit rate limit...' + '\n')
            print(str(e))
        except Exception as e:
            lastId = tweets[0].id
            data['lastId'] = lastId
            dal.setData(data)
            print('We have a problem!' + '\n')
            print(str(e))

        print('Now I\'m sleeping for a minute...' + '\n')
        time.sleep(60)


def send_message(message, BOT_TOKEN, CHANNEL_ID):
    requests.get(f'https://api.telegram.org/bot{BOT_TOKEN}/sendMessage?chat_id={CHANNEL_ID}&text={message}&parse_mode=html')


def getTwitterAPI(data):
    # Authenticate to Twitter
    auth = tweepy.OAuthHandler(data['apiKey'], data['apiSecret'])
    auth.set_access_token(data['accessToken'], data['accessSecret'])
    return tweepy.API(auth)


def getMessage(tweet):
    message = '<b>'
    message += tweet.user.name
    message += ':\n</b>'
    message += tweet.text
    return message


if __name__ == '__main__':
    main()
